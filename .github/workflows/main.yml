name: Auto Building Workflow

on:
  push:
    tags:
      - "v*" # 當推送到 v 開頭的標籤時觸發構建與發布
  workflow_dispatch: # 允許手動觸發構建

env:
  QT_VERSION: 6.6.2
  BUILD_TYPE: Release
  PROJECT_NAME: PyUtau

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # 使用特定版本鏡像以確保環境一致性
        os: [windows-latest, ubuntu-22.04, macos-latest]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ─────────────────────────────────
      # 1. 環境準備
      # ─────────────────────────────────
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-cursor0 libxcb-xinerama0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-shape0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          # 確保 host 與 runner 匹配
          host: ${{ runner.os == 'Windows' && 'windows' || (runner.os == 'Linux' && 'linux' || 'mac') }}

      # ─────────────────────────────────
      # 2. 編譯階段
      # ─────────────────────────────────
      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build Project
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      # ─────────────────────────────────
      # 3. 平台特定打包 (Windows 便攜化優化)
      # ─────────────────────────────────
      
      # Windows：建立獨立目錄並導入所有運行庫
      - name: Package Windows Portable
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $DIST_DIR = "PyUtau-Windows-Portable"
          New-Item -ItemType Directory -Path $DIST_DIR
          # 尋找編譯出的 .exe (排除 CMake 中間文件)
          $EXE_PATH = Get-ChildItem -Path build -Filter "${{ env.PROJECT_NAME }}*.exe" -Recurse | Where-Object { $_.FullName -notlike "*\CMakeFiles\*" } | Select-Object -First 1 -ExpandProperty FullName
          Copy-Item $EXE_PATH "$DIST_DIR/"
          # 執行 windeployqt 並包含編譯器運行庫 (msvcp140.dll 等)
          windeployqt --dir "$DIST_DIR" --compiler-runtime --verbose 1 "$DIST_DIR/$(Split-Path $EXE_PATH -Leaf)"
          # 壓縮
          Compress-Archive -Path "$DIST_DIR\*" -DestinationPath "${{ env.PROJECT_NAME }}-Windows-x64.zip"

      # macOS：使用 macdeployqt 修復庫路徑
      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          APP_PATH=$(find build -name "*.app" | head -n 1)
          # macdeployqt 會將 Qt 框架嵌入到 .app 內部
          macdeployqt "$APP_PATH" -dmg
          # 同時提供 zip 版
          zip -r "${{ env.PROJECT_NAME }}-macOS.zip" "$APP_PATH"
          mv build/*.dmg "${{ env.PROJECT_NAME }}-macOS.dmg" || true

      # Linux：打包二進制
      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          DIST_DIR="dist-linux"
          mkdir -p $DIST_DIR
          find build -maxdepth 2 -executable -type f -name "${{ env.PROJECT_NAME }}*" -exec cp {} $DIST_DIR/ \;
          tar -czf "${{ env.PROJECT_NAME }}-Linux.tar.gz" -C $DIST_DIR .

      # ─────────────────────────────────
      # 4. 上傳構建產物到 Artifacts (暫存)
      # ─────────────────────────────────
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-build
          path: |
            *.zip
            *.tar.gz
            *.dmg

  # ─────────────────────────────────
  # 5. 自動發布到 GitHub Release
  # ─────────────────────────────────
  release:
    name: Publish GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write # 賦予建立 Release 的權限
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloads
          merge-multiple: true # 將所有平台的產物合併到同一層級

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./downloads/*.zip
            ./downloads/*.tar.gz
            ./downloads/*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
